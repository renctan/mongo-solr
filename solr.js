var MSolrConst={MONGO_SOLR_COLLECTION_NAME:"mongo_solr",SOLR_URL_KEY:"url",LIST_KEY:"l",NS_KEY:"ns",COLL_FIELD_KEY:"f",LAST_TIMESTAMP_KEY:"ts"};var MSolrDb=function(a,c,b){this.configColl=a;this.configDB=a.getDB();this.serverLocation=c;this.dbName=b};MSolrDb.prototype.indexAll=function(a){for(var c=this.configColl.getMongo().getDB(this.dbName).getCollectionNames(),a=a||!1,b,d=c.length;d--;)b=c[d],/^system\..*/.test(b)||this.index(c[d],null);a&&this.configDB.getLastError()};
MSolrDb.prototype.index=function(a,c,b){var a=this.dbName+"."+a,b=b||!1,d={},e={},f={},g={},h=MSolrConst.LIST_KEY+"."+MSolrConst.NS_KEY;g[MSolrConst.SOLR_URL_KEY]=this.serverLocation;f.$ne=a;g[h]=f;e[MSolrConst.NS_KEY]=a;d[MSolrConst.LIST_KEY]=e;this.configColl.update(g,{$push:d});if(c!=null&&(c=this.configDB.runCommand({$getLastError:1}),c.n==0))g={},g[MSolrConst.SOLR_URL_KEY]=this.serverLocation,g[h]=a;b&&this.configDB.getLastError()};
MSolrDb.prototype.remove=function(a,c){var b=this.dbName+"."+a,d={},e=c||!1,f={},g={};d[MSolrConst.SOLR_URL_KEY]=this.serverLocation;g[MSolrConst.NS_KEY]=b;f[MSolrConst.LIST_KEY]=g;this.configColl.update(d,{$pull:f});e&&this.configDB.getLastError()};MSolrDb.prototype.toString=function(){return this.dbName+" -> "+this.serverLocation};MSolrDb.prototype.tojson=function(){return this.toString()};var MSolrServer=function(a,c){var b={};this.configColl=a;this.configDB=a.getDB();this.loc=c;b[MSolrConst.SOLR_URL_KEY]=this.loc;this.configColl.update(b,{$set:b},!0)};MSolrServer.prototype.db=function(a){return new MSolrDb(this.configColl,this.loc,a)};MSolrServer.prototype.removeDB=function(a,c){var b={},d={},e={},f=c||!1;b[MSolrConst.SOLR_URL_KEY]=this.loc;e[MSolrConst.NS_KEY]=RegExp("^"+a+"\\..+");d[MSolrConst.LIST_KEY]=e;this.configColl.update(b,{$pull:d});f&&this.configDB.getLastError()};
MSolrServer.prototype.toString=function(){return this.loc};MSolrServer.prototype.tojson=function(){return this.toString()};var MSolr=function(a,c){var b=new Mongo,d=a||MSolr.getConfigDBName(b),e=c||MSolrConst.MONGO_SOLR_COLLECTION_NAME,f={};this.db=b.getDB(d);this.coll=this.db.getCollection(e);f[MSolrConst.SOLR_URL_KEY]=1;this.coll.ensureIndex(f,{unique:!0})};MSolr.getConfigDBName=function(a){for(var c=!1,b="config",a=a.getDBs().databases,d=a.length;d--;)if(a[d].name=="config"){c=!0;break}c||(b="local");return b};MSolr.prototype.showConfig=function(){return this.coll.find()};
MSolr.prototype.changeUrl=function(a,c,b){var d={},e={},b=b||!1;d[MSolrConst.SOLR_URL_KEY]=a;e[MSolrConst.SOLR_URL_KEY]=c;this.coll.update(d,{$set:e});b&&this.db.getLastError()};MSolr.prototype.removeServer=function(a,c){var b={},d=c||!1;b[MSolrConst.SOLR_URL_KEY]=a;this.coll.remove(b);d&&this.db.getLastError()};MSolr.prototype.server=function(a){return new MSolrServer(this.coll,a)};MSolr.prototype.index=function(a,c,b,d){b==null?this.server(a).db(c).indexAll():this.server(a).db(c).index(b,d)};
MSolr.prototype.toString=function(){return"config_collection: "+this.coll._fullName};MSolr.prototype.tojson=function(){return this.toString()};
