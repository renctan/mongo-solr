var MSolrConst={MONGO_SOLR_COLLECTION_NAME:"mongo_solr",SOLR_URL_KEY:"url",NS_KEY:"ns",COLL_FIELD_KEY:"f"};var MSolrDb=function(a,c,b){this.configColl=a;this.configDB=a.getDB();this.serverLocation=c;this.dbName=b};MSolrDb.prototype.indexAll=function(a){for(var c=this.configColl.getMongo().getDB(this.dbName).getCollectionNames(),a=a||!1,b,d=c.length;d--;)b=c[d],/^system\..*/.test(b)||this.index(c[d],null);a&&this.configDB.getLastError()};
MSolrDb.prototype.index=function(a,c,b){var a=this.dbName+"."+a,b=b||!1,d={},e={},f={};f[MSolrConst.SOLR_URL_KEY]=this.serverLocation;f[MSolrConst.NS_KEY]=a;if(c!=null)e[c]=MSolrDb.INDEX_COLL_FIELD_OPT,d[MSolrConst.COLL_FIELD_KEY]=e;this.configColl.update(f,{$set:d},!0);b&&this.configDB.getLastError()};MSolrDb.prototype.remove=function(a,c){var b=this.dbName+"."+a,d={},e=c||!1;d[MSolrConst.SOLR_URL_KEY]=this.serverLocation;d[MSolrConst.NS_KEY]=b;this.configColl.remove(d);e&&this.configDB.getLastError()};
MSolrDb.prototype.toString=function(){return this.dbName+" -> "+this.serverLocation};MSolrDb.prototype.tojson=function(){return this.toString()};var MSolrServer=function(a,c){this.configColl=a;this.configDB=a.getDB();this.loc=c};MSolrServer.prototype.db=function(a){return new MSolrDb(this.configColl,this.loc,a)};MSolrServer.prototype.removeDB=function(a,c){var b={},d=c||!1;b[MSolrConst.SOLR_URL_KEY]=this.loc;b[MSolrConst.NS_KEY]=RegExp("^"+a+"\\..+");this.configColl.remove(b);d&&this.configDB.getLastError()};MSolrServer.prototype.toString=function(){return this.loc};MSolrServer.prototype.tojson=function(){return this.toString()};var MSolr=function(a,c){var b=new Mongo,d=a||MSolr.getConfigDBName(b),e=c||MSolrConst.MONGO_SOLR_COLLECTION_NAME,f={};this.db=b.getDB(d);this.coll=this.db.getCollection(e);f[MSolrConst.SOLR_URL_KEY]=1;f[MSolrConst.NS_KEY]=1;this.coll.ensureIndex(f,{unique:!0})};MSolr.getConfigDBName=function(a){for(var c=!1,b="config",a=a.getDBs().databases,d=a.length;d--;)if(a[d].name=="config"){c=!0;break}c||(b="local");return b};MSolr.prototype.showConfig=function(){return this.coll.find()};
MSolr.prototype.changeUrl=function(a,c,b){var d={},e={},b=b||!1;d[MSolrConst.SOLR_URL_KEY]=a;e[MSolrConst.SOLR_URL_KEY]=c;this.coll.update(d,{$set:e});b&&this.db.getLastError()};MSolr.prototype.removeServer=function(a,c){var b={},d=c||!1;b[MSolrConst.SOLR_URL_KEY]=a;this.coll.remove(b);d&&this.db.getLastError()};MSolr.prototype.server=function(a){return new MSolrServer(this.coll,a)};MSolr.prototype.index=function(a,c,b,d){b==null?this.server(a).db(c).indexAll():this.server(a).db(c).index(b,d)};
MSolr.prototype.toString=function(){return"config_collection: "+this.coll._fullName};MSolr.prototype.tojson=function(){return this.toString()};
