var MSolrConst={CONFIG_COLLECTION_NAME:"msolr",SOLR_URL_KEY:"url",NS_KEY:"ns",COLL_FIELD_KEY:"f",LAST_TIMESTAMP_KEY:"ts"};var MSolrServer=function(b,c){this.configColl=b;this.configDB=b.getDB();this.loc=c};MSolrServer.prototype.index=function(b,c,a){b.indexOf(".")==-1?this._indexByDB(b,a):this._indexByNS(b,c,a)};MSolrServer.prototype.remove=function(b,c,a){b.indexOf(".")==-1?this._removeByDB(b,a):this._removeByNS(b,c,a)};
MSolrServer.prototype._indexByDB=function(b,c){for(var a=this.configColl.getMongo().getDB(b).getCollectionNames(),d=c||!1,f,e=a.length;e--;)f=a[e],/^system\..*/.test(f)||this._indexByNS(b+"."+a[e],null);d&&this.configDB.getLastError()};MSolrServer.prototype._removeByDB=function(b,c){var a={},d=c||!1;a[MSolrConst.SOLR_URL_KEY]=this.loc;a[MSolrConst.NS_KEY]=RegExp("^"+b+"\\..+");this.configColl.remove(a);d&&this.configDB.getLastError()};
MSolrServer.prototype._indexByNS=function(b,c,a){var a=a||!1,d={},f={},e={};e[MSolrConst.SOLR_URL_KEY]=this.loc;e[MSolrConst.NS_KEY]=b;if(c!=null)f[c]=MSolrDb.INDEX_COLL_FIELD_OPT,d[MSolrConst.COLL_FIELD_KEY]=f;this.configColl.update(e,{$set:d},!0);a&&this.configDB.getLastError()};MSolrServer.prototype._removeByNS=function(b,c){var a={},d=c||!1;a[MSolrConst.SOLR_URL_KEY]=this.loc;a[MSolrConst.NS_KEY]=b;this.configColl.remove(a);d&&this.configDB.getLastError()};MSolrServer.prototype.toString=function(){return this.loc};
MSolrServer.prototype.tojson=function(){return this.toString()};var MSolr=function(b,c){var a=new Mongo,d=b||MSolr.getConfigDBName(a),f=c||MSolrConst.CONFIG_COLLECTION_NAME,e={};this.db=a.getDB(d);this.coll=this.db.getCollection(f);e[MSolrConst.SOLR_URL_KEY]=1;e[MSolrConst.NS_KEY]=1;this.coll.ensureIndex(e,{unique:!0})};MSolr.getConfigDBName=function(b){for(var c=!1,a="config",b=b.getDBs().databases,d=b.length;d--;)if(b[d].name=="config"){c=!0;break}c||(a="local");return a};MSolr.prototype.showConfig=function(){return this.coll.find()};
MSolr.prototype.changeUrl=function(b,c,a){var d={},f={},a=a||!1;d[MSolrConst.SOLR_URL_KEY]=b;f[MSolrConst.SOLR_URL_KEY]=c;this.coll.update(d,{$set:f});a&&this.db.getLastError()};MSolr.prototype.removeServer=function(b,c){var a={},d=c||!1;a[MSolrConst.SOLR_URL_KEY]=b;this.coll.remove(a);d&&this.db.getLastError()};MSolr.prototype.server=function(b){return new MSolrServer(this.coll,b)};MSolr.prototype.index=function(b,c,a,d){a==null?this.server(b).index(c):this.server(b).index(c+"."+a,d)};
MSolr.prototype.toString=function(){return"config_collection: "+this.coll.getFullName()};MSolr.prototype.tojson=function(){return this.toString()};MSolr.prototype._getConfigColl=function(){return this.coll};MSolr.prototype.reset=function(){return this.coll.remove()};MSolr.DEFAULT=new MSolr;MSolr.showConfig=function(){return MSolr.DEFAULT.showConfig()};MSolr.reset=function(){return MSolr.DEFAULT.reset()};
