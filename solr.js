var MSolrConst={CONFIG_COLLECTION_NAME:"msolr",SOLR_URL_KEY:"url",NS_KEY:"ns",COLL_FIELD_KEY:"f",LAST_TIMESTAMP_KEY:"ts"};var MSolrUtil={getLastError:function(a,b,c){a=a.runCommand({getlasterror:1,w:b,wtimeout:c});a.err!=null&&print("Failed to apply changes to all replicas: "+a.err)}};var MSolrServer=function(a,b,c){c=c||{};this.repCount=c.repCount||1;this.timeout=c.timeout||1E3;this.configColl=a;this.configDB=a.getDB();this.loc=b};MSolrServer.prototype.index=function(a,b){a.indexOf(".")==-1?this._indexByDB(a):this._indexByNS(a,b)};MSolrServer.prototype.remove=function(a,b){a.indexOf(".")==-1?this._removeByDB(a):this._removeByNS(a,b)};
MSolrServer.prototype._indexByDB=function(a){for(var b=this.configColl.getMongo().getDB(a).getCollectionNames(),c,d=b.length;d--;)c=b[d],/^system\..*/.test(c)||this._indexByNS(a+"."+b[d],null);MSolrUtil.getLastError(this.configDB,this.repCount,this.timeout)};MSolrServer.prototype._removeByDB=function(a){var b={};b[MSolrConst.SOLR_URL_KEY]=this.loc;b[MSolrConst.NS_KEY]=RegExp("^"+a+"\\..+");this.configColl.remove(b);MSolrUtil.getLastError(this.configDB,this.repCount,this.timeout)};
MSolrServer.prototype._indexByNS=function(a,b){var c={},d={},e={};e[MSolrConst.SOLR_URL_KEY]=this.loc;e[MSolrConst.NS_KEY]=a;if(b!=null)d[b]=MSolrDb.INDEX_COLL_FIELD_OPT,c[MSolrConst.COLL_FIELD_KEY]=d;this.configColl.update(e,{$set:c},!0);MSolrUtil.getLastError(this.configDB,this.repCount,this.timeout)};MSolrServer.prototype._removeByNS=function(a){var b={};b[MSolrConst.SOLR_URL_KEY]=this.loc;b[MSolrConst.NS_KEY]=a;this.configColl.remove(b);MSolrUtil.getLastError(this.configDB,this.repCount,this.timeout)};
MSolrServer.prototype.toString=function(){return this.loc};MSolrServer.prototype.tojson=function(){return this.toString()};var MSolr=function(a,b){var c=db.getMongo(),d=a||MSolr.getConfigDBName(c),e=b||MSolrConst.CONFIG_COLLECTION_NAME,f={},g=rs.status(),h=0;this.db=c.getDB(d);this.coll=this.db.getCollection(e);f[MSolrConst.SOLR_URL_KEY]=1;f[MSolrConst.NS_KEY]=1;if(g.errmsg==null){c=g.members;for(d=c.length;d--;)(c[d].state==1||c[d].state==2)&&h++;this.repCount=h}else this.repCount=1;this.coll.ensureIndex(f,{unique:!0})};MSolr._wtimeout=2E3;MSolr.getConfigDBName=function(){return"config"};MSolr.prototype.showConfig=function(){return this.coll.find()};
MSolr.prototype.changeUrl=function(a,b){var c={},d={};c[MSolrConst.SOLR_URL_KEY]=a;d[MSolrConst.SOLR_URL_KEY]=b;this.coll.update(c,{$set:d});MSolrUtil.getLastError(this.db,this.repCount,MSolr._wtimeout)};MSolr.prototype.removeServer=function(a){var b={};b[MSolrConst.SOLR_URL_KEY]=a;this.coll.remove(b);MSolrUtil.getLastError(this.db,this.repCount,MSolr._wtimeout)};MSolr.prototype.server=function(a){return new MSolrServer(this.coll,a,{repCount:this.repCount,timeout:MSolr._wtimeout})};
MSolr.prototype.index=function(a,b,c,d){c==null?this.server(a).index(b):this.server(a).index(b+"."+c,d)};MSolr.prototype.toString=function(){return"config_collection: "+this.coll.getFullName()};MSolr.prototype.tojson=function(){return this.toString()};MSolr.prototype._getConfigColl=function(){return this.coll};MSolr.prototype.reset=function(){return this.coll.remove()};MSolr.DEFAULT=new MSolr;MSolr.showConfig=function(){return MSolr.DEFAULT.showConfig()};MSolr.reset=function(){return MSolr.DEFAULT.reset()};
